name: ãƒ•ã‚©ãƒ¼ã‚¯å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯

on:
  push:
    branches: [main, develop, "feature/*"]
  pull_request:
    branches: [main, develop]

jobs:
  safety-check:
    runs-on: ubuntu-latest
    name: ãƒªãƒã‚¸ãƒˆãƒªå®‰å…¨æ€§æ¤œè¨¼

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œè¨¼
        run: |
          echo "ğŸ” ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™..."
          echo "ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
          echo "ãƒªãƒã‚¸ãƒˆãƒªæ‰€æœ‰è€…: ${{ github.repository_owner }}"
          echo "ã‚¢ã‚¯ã‚¿ãƒ¼: ${{ github.actor }}"

          # æ­£ã—ã„ãƒ•ã‚©ãƒ¼ã‚¯ã«ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
          if [ "${{ github.repository }}" != "BoxPistols/shadcn-admin" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯BoxPistols/shadcn-adminã§ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ã¹ãã§ã™"
            echo "ç¾åœ¨ã®ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
            exit 1
          fi

          echo "âœ… ãƒªãƒã‚¸ãƒˆãƒªæ¤œè¨¼ãŒé€šéã—ã¾ã—ãŸ"

      - name: ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ å‚ç…§ã‚’ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ” ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ å‚ç…§ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™..."

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸æ­£ã«ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å‚ç…§ã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if grep -r "satnaing/shadcn-admin" .github/workflows/ 2>/dev/null; then
            echo "âš ï¸ è­¦å‘Š: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ å‚ç…§ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          fi

          # åˆ©ç”¨å¯èƒ½ãªå ´åˆã¯gitãƒªãƒ¢ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
          if [ -d ".git" ]; then
            echo "ğŸ“‹ Gitãƒªãƒ¢ãƒ¼ãƒˆ:"
            git remote -v || echo "gitãƒªãƒ¢ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: ãƒ–ãƒ©ãƒ³ãƒå®‰å…¨æ€§ã‚’æ¤œè¨¼
        run: |
          echo "ğŸ” ãƒ–ãƒ©ãƒ³ãƒå®‰å…¨æ€§ã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™..."

          BRANCH_NAME="${{ github.ref_name }}"
          echo "ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"

          # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‹ãƒã‚§ãƒƒã‚¯
          if [ "$BRANCH_NAME" = "main" ] && [ "${{ github.event_name }}" = "push" ]; then
            echo "âš ï¸ è­¦å‘Š: ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "ğŸ’¡ ã“ã‚ŒãŒã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ åŒæœŸã«ã‚ˆã‚‹ã‚‚ã®ã§ã‚ã‚Šã€ç›´æ¥é–‹ç™ºã§ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          fi

          # ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ–ãƒ©ãƒ³ãƒã®å‘½åã‚’ãƒã‚§ãƒƒã‚¯
          if echo "$BRANCH_NAME" | grep -E "^feature/.+" > /dev/null; then
            echo "âœ… ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ–ãƒ©ãƒ³ãƒã®å‘½åãŒæ­£ã—ã„ã§ã™"
          elif [ "$BRANCH_NAME" != "main" ] && [ "$BRANCH_NAME" != "develop" ]; then
            echo "âš ï¸ è­¦å‘Š: ãƒ–ãƒ©ãƒ³ãƒåãŒfeature/*ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã£ã¦ã„ã¾ã›ã‚“"
          fi

      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: pnpmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g pnpm

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: ãƒªãƒ³ãƒˆã‚’å®Ÿè¡Œ
        run: pnpm run lint

      - name: å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        run: pnpm run build

      - name: æˆåŠŸé€šçŸ¥
        run: |
          echo "ğŸ‰ ã™ã¹ã¦ã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ãŒé€šéã—ã¾ã—ãŸï¼"
          echo "âœ… ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "âœ… ã‚¢ã‚¯ã‚¿ãƒ¼: ${{ github.actor }}"
